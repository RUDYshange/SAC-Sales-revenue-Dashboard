<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SAP Analytics Cloud - Revenue Dashboard</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f5f6fa;
            color: #2c3e50;
            min-height: 100vh;
        }

        /* SAP SAC Header */
        .sac-header {
            background: #ffffff;
            border-bottom: 1px solid #e1e5e9;
            padding: 0.75rem 1.5rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            max-width: 1600px;
            margin: 0 auto;
        }

        .sap-logo {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .sap-logo .logo-icon {
            width: 32px;
            height: 32px;
            background: linear-gradient(135deg, #0070f3, #00d4ff);
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 14px;
        }

        .sap-logo .logo-text {
            font-size: 1.1rem;
            font-weight: 600;
            color: #2c3e50;
        }

        .header-actions {
            display: flex;
            gap: 1rem;
            align-items: center;
        }

        .action-btn {
            background: #ffffff;
            border: 1px solid #d1d9e0;
            padding: 0.5rem 1rem;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.85rem;
            transition: all 0.2s ease;
        }

        .action-btn:hover {
            background: #f8f9fa;
            border-color: #0070f3;
        }

        .action-btn.primary {
            background: #0070f3;
            color: white;
            border-color: #0070f3;
        }

        .action-btn.primary:hover {
            background: #0060d3;
        }

        .action-btn.upload {
            background: #28a745;
            color: white;
            border-color: #28a745;
        }

        .action-btn.upload:hover {
            background: #218838;
        }

        /* Navigation Bar */
        .nav-bar {
            background: #ffffff;
            border-bottom: 1px solid #e1e5e9;
            padding: 0.5rem 1.5rem;
        }

        .nav-content {
            max-width: 1600px;
            margin: 0 auto;
            display: flex;
            gap: 2rem;
        }

        .nav-item {
            padding: 0.5rem 0;
            color: #6c757d;
            text-decoration: none;
            font-size: 0.9rem;
            border-bottom: 2px solid transparent;
            transition: all 0.2s ease;
        }

        .nav-item:hover,
        .nav-item.active {
            color: #0070f3;
            border-bottom-color: #0070f3;
        }

        /* Dashboard Container */
        .dashboard-container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 1.5rem;
            display: grid;
            gap: 1.5rem;
        }

        /* Upload Modal */
        .upload-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
        }

        .upload-modal-content {
            background: #ffffff;
            width: 90%;
            max-width: 700px;
            margin: 3% auto;
            border-radius: 8px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.2);
            overflow: hidden;
            max-height: 90vh;
            overflow-y: auto;
        }

        .upload-modal-header {
            padding: 1.5rem;
            border-bottom: 1px solid #e1e5e9;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #f8f9fa;
        }

        .upload-modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #6c757d;
        }

        .upload-modal-body {
            padding: 2rem;
        }

        .upload-area {
            border: 2px dashed #d1d9e0;
            border-radius: 8px;
            padding: 3rem 2rem;
            text-align: center;
            transition: all 0.3s ease;
            cursor: pointer;
            margin-bottom: 1.5rem;
        }

        .upload-area:hover,
        .upload-area.dragover {
            border-color: #0070f3;
            background: rgba(0, 112, 243, 0.05);
        }

        .upload-icon {
            font-size: 3rem;
            color: #6c757d;
            margin-bottom: 1rem;
        }

        .upload-text {
            color: #6c757d;
            margin-bottom: 0.5rem;
        }

        .upload-subtext {
            font-size: 0.85rem;
            color: #6c757d;
        }

        .file-input {
            display: none;
        }

        .upload-progress {
            display: none;
            margin: 1rem 0;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: #f1f3f4;
            border-radius: 4px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: #0070f3;
            width: 0%;
            transition: width 0.3s ease;
        }

        .data-preview {
            display: none;
            margin-top: 1.5rem;
        }

        .preview-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.85rem;
            max-height: 200px;
            overflow-y: auto;
            display: block;
        }

        .preview-table thead {
            background: #f8f9fa;
            position: sticky;
            top: 0;
        }

        .preview-table th,
        .preview-table td {
            padding: 0.5rem;
            border: 1px solid #e1e5e9;
            text-align: left;
        }

        .field-mapping {
            display: none;
            margin-top: 1.5rem;
            padding: 1.5rem;
            background: #f8f9fa;
            border-radius: 6px;
            border: 1px solid #e1e5e9;
        }

        .mapping-header {
            margin-bottom: 1rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid #d1d9e0;
        }

        .mapping-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            padding: 0.75rem;
            background: white;
            border-radius: 4px;
            border: 1px solid #e1e5e9;
        }

        .mapping-info {
            flex: 1;
        }

        .mapping-label {
            font-weight: 500;
            color: #2c3e50;
            margin-bottom: 0.25rem;
        }

        .mapping-description {
            font-size: 0.8rem;
            color: #6c757d;
        }

        .mapping-select {
            padding: 0.5rem;
            border: 1px solid #d1d9e0;
            border-radius: 4px;
            font-size: 0.85rem;
            min-width: 180px;
            background: white;
        }

        .mapping-select:focus {
            outline: none;
            border-color: #0070f3;
            box-shadow: 0 0 0 2px rgba(0, 112, 243, 0.1);
        }

        .mapping-required {
            color: #dc3545;
            font-weight: bold;
        }

        .mapping-optional {
            color: #28a745;
            font-size: 0.75rem;
        }

        .upload-actions {
            display: none;
            margin-top: 1.5rem;
            padding-top: 1.5rem;
            border-top: 1px solid #e1e5e9;
            text-align: right;
        }

        .upload-actions button {
            margin-left: 0.5rem;
        }

        /* Success Message */
        .success-message {
            display: none;
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
            padding: 1rem;
            border-radius: 6px;
            margin-bottom: 1rem;
        }

        .error-message {
            display: none;
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
            padding: 1rem;
            border-radius: 6px;
            margin-bottom: 1rem;
        }

        /* Filters Section */
        .filters-section {
            background: #ffffff;
            border: 1px solid #e1e5e9;
            border-radius: 8px;
            padding: 1rem;
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
            align-items: center;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
        }

        .filter-label {
            font-size: 0.75rem;
            color: #6c757d;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .filter-control {
            border: 1px solid #d1d9e0;
            border-radius: 4px;
            padding: 0.5rem;
            font-size: 0.85rem;
            background: #ffffff;
            min-width: 120px;
        }

        .filter-control:focus {
            outline: none;
            border-color: #0070f3;
            box-shadow: 0 0 0 2px rgba(0, 112, 243, 0.1);
        }

        /* KPI Cards */
        .kpi-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 1rem;
        }

        .kpi-card {
            background: #ffffff;
            border: 1px solid #e1e5e9;
            border-radius: 8px;
            padding: 1.5rem;
            position: relative;
            transition: all 0.2s ease;
            cursor: pointer;
        }

        .kpi-card:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            transform: translateY(-2px);
        }

        .kpi-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, #0070f3, #00d4ff);
            border-radius: 8px 8px 0 0;
        }

        .kpi-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 1rem;
        }

        .kpi-title {
            font-size: 0.8rem;
            color: #6c757d;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .kpi-icon {
            width: 24px;
            height: 24px;
            background: #f8f9fa;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            color: #6c757d;
        }

        .kpi-value {
            font-size: 2rem;
            font-weight: 700;
            color: #2c3e50;
            margin-bottom: 0.5rem;
            line-height: 1;
        }

        .kpi-change {
            display: flex;
            align-items: center;
            gap: 0.25rem;
            font-size: 0.75rem;
            font-weight: 500;
        }

        .kpi-change.positive {
            color: #28a745;
        }

        .kpi-change.negative {
            color: #dc3545;
        }

        .kpi-change-arrow {
            font-size: 0.7rem;
        }

        /* Chart Containers */
        .charts-grid {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 1.5rem;
        }

        .chart-container {
            background: #ffffff;
            border: 1px solid #e1e5e9;
            border-radius: 8px;
            padding: 1.5rem;
        }

        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid #f1f3f4;
        }

        .chart-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: #2c3e50;
        }

        .chart-actions {
            display: flex;
            gap: 0.5rem;
        }

        .chart-action {
            background: none;
            border: none;
            padding: 0.25rem;
            cursor: pointer;
            color: #6c757d;
            border-radius: 4px;
            transition: all 0.2s ease;
        }

        .chart-action:hover {
            background: #f8f9fa;
            color: #2c3e50;
        }

        /* Data Table */
        .data-table-container {
            background: #ffffff;
            border: 1px solid #e1e5e9;
            border-radius: 8px;
            overflow: hidden;
        }

        .table-header {
            padding: 1.5rem;
            border-bottom: 1px solid #f1f3f4;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
        }

        .data-table th {
            background: #f8f9fa;
            padding: 0.75rem;
            text-align: left;
            font-size: 0.8rem;
            font-weight: 600;
            color: #6c757d;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            border-bottom: 1px solid #e1e5e9;
        }

        .data-table td {
            padding: 1rem 0.75rem;
            border-bottom: 1px solid #f1f3f4;
            font-size: 0.85rem;
        }

        .data-table tbody tr:hover {
            background: #f8f9fa;
        }

        .status-indicator {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-right: 0.5rem;
        }

        .status-completed {
            background: #28a745;
        }

        .status-pending {
            background: #ffc107;
        }

        .status-cancelled {
            background: #dc3545;
        }

        /* Responsive Design */
        @media (max-width: 1200px) {
            .charts-grid {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 768px) {
            .kpi-grid {
                grid-template-columns: 1fr;
            }

            .filters-section {
                flex-direction: column;
                align-items: stretch;
            }

            .dashboard-container {
                padding: 1rem;
            }

            .mapping-row {
                flex-direction: column;
                align-items: stretch;
                gap: 0.5rem;
            }

            .mapping-select {
                min-width: unset;
            }
        }

        /* Loading States */
        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 200px;
            color: #6c757d;
        }

        .spinner {
            width: 20px;
            height: 20px;
            border: 2px solid #f3f3f3;
            border-top: 2px solid #0070f3;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 0.5rem;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <!-- SAC Header -->
    <div class="sac-header">
        <div class="header-content">
            <div class="sap-logo">
                <div class="logo-icon">SAC</div>
                <div class="logo-text">SAP Analytics Cloud</div>
            </div>
            <div class="header-actions">
                <button class="action-btn">📊 Stories</button>
                <button class="action-btn">📈 Models</button>
                <button class="action-btn upload" onclick="openUploadModal()">📂 Upload Data</button>
                <button class="action-btn">⚙️ Settings</button>
                <button class="action-btn primary">💾 Save</button>
            </div>
        </div>
    </div>

    <!-- Navigation -->
    <div class="nav-bar">
        <div class="nav-content">
            <a href="#" class="nav-item active">Revenue Dashboard</a>
            <a href="#" class="nav-item">Sales Analysis</a>
            <a href="#" class="nav-item">Product Performance</a>
            <a href="#" class="nav-item">Regional Analytics</a>
            <a href="#" class="nav-item">Forecasting</a>
        </div>
    </div>

    <div class="dashboard-container">
        <!-- Success Message -->
        <div id="successMessage" class="success-message">
            <strong>Success!</strong> Your data has been uploaded and the dashboard has been updated.
        </div>

        <!-- Error Message -->
        <div id="errorMessage" class="error-message">
            <strong>Error!</strong> <span id="errorText"></span>
        </div>

        <!-- Filters Section -->
        <div class="filters-section">
            <div class="filter-group">
                <div class="filter-label">Time Period</div>
                <select class="filter-control" id="timePeriodFilter">
                    <option value="MTD">Month to Date</option>
                    <option value="QTD">Quarter to Date</option>
                    <option value="YTD" selected>Year to Date</option>
                    <option value="custom">Custom Range</option>
                </select>
            </div>
            <div class="filter-group">
                <div class="filter-label">Product Line</div>
                <select class="filter-control" id="productFilter">
                    <option value="all">All Products</option>
                </select>
            </div>
            <div class="filter-group">
                <div class="filter-label">Region</div>
                <select class="filter-control" id="regionFilter">
                    <option value="all">Global</option>
                </select>
            </div>
            <div class="filter-group">
                <div class="filter-label">Currency</div>
                <select class="filter-control" id="currencyFilter">
                    <option value="USD">USD ($)</option>
                    <option value="ZAR">ZAR (R)</option>
                    <option value="EUR">EUR (€)</option>
                </select>
            </div>
        </div>

        <!-- KPI Cards -->
        <div class="kpi-grid">
            <div class="kpi-card">
                <div class="kpi-header">
                    <div class="kpi-title">Total Revenue</div>
                    <div class="kpi-icon">💰</div>
                </div>
                <div class="kpi-value" id="totalRevenue">$0</div>
                <div class="kpi-change positive" id="revenueChange">
                    <span class="kpi-change-arrow">↗</span>
                    <span>+0% vs last period</span>
                </div>
            </div>

            <div class="kpi-card">
                <div class="kpi-header">
                    <div class="kpi-title">Average Transaction</div>
                    <div class="kpi-icon">📊</div>
                </div>
                <div class="kpi-value" id="avgTransaction">$0</div>
                <div class="kpi-change positive" id="avgChange">
                    <span class="kpi-change-arrow">↗</span>
                    <span>+0% vs last period</span>
                </div>
            </div>

            <div class="kpi-card">
                <div class="kpi-header">
                    <div class="kpi-title">Total Transactions</div>
                    <div class="kpi-icon">🔢</div>
                </div>
                <div class="kpi-value" id="totalTransactions">0</div>
                <div class="kpi-change positive" id="transactionChange">
                    <span class="kpi-change-arrow">↗</span>
                    <span>+0% vs last period</span>
                </div>
            </div>

            <div class="kpi-card">
                <div class="kpi-header">
                    <div class="kpi-title">Success Rate</div>
                    <div class="kpi-icon">✅</div>
                </div>
                <div class="kpi-value" id="successRate">0%</div>
                <div class="kpi-change positive" id="successChange">
                    <span class="kpi-change-arrow">↗</span>
                    <span>+0% vs last period</span>
                </div>
            </div>
        </div>

        <!-- Charts Grid -->
        <div class="charts-grid">
            <!-- Revenue Trend Chart -->
            <div class="chart-container">
                <div class="chart-header">
                    <div class="chart-title">Revenue Trend Analysis</div>
                    <div class="chart-actions">
                        <button class="chart-action" onclick="exportChart('revenue')" title="Export">📊</button>
                        <button class="chart-action" onclick="fullscreenChart('revenue')" title="Fullscreen">⛶</button>
                    </div>
                </div>
                <canvas id="revenueChart" style="max-height: 300px;"></canvas>
            </div>

            <!-- Revenue Breakdown -->
            <div class="chart-container">
                <div class="chart-header">
                    <div class="chart-title">Revenue by Category</div>
                    <div class="chart-actions">
                        <button class="chart-action" onclick="exportChart('breakdown')" title="Export">📊</button>
                        <button class="chart-action" onclick="fullscreenChart('breakdown')" title="Fullscreen">⛶</button>
                    </div>
                </div>
                <canvas id="breakdownChart" style="max-height: 300px;"></canvas>
            </div>
        </div>

        <!-- Data Table -->
        <div class="data-table-container">
            <div class="table-header">
                <div class="chart-title">Transaction Data</div>
                <div style="display: flex; gap: 0.5rem;">
                    <button class="action-btn" onclick="exportTable()">Export</button>
                    <button class="action-btn" onclick="refreshData()">Refresh</button>
                </div>
            </div>
            <table class="data-table">
                <thead>
                    <tr id="tableHeaders">
                        <!-- Headers will be populated dynamically -->
                    </tr>
                </thead>
                <tbody id="transactionTableBody">
                    <!-- Data will be populated here -->
                </tbody>
            </table>
        </div>
    </div>

    <!-- Upload Modal -->
    <div id="uploadModal" class="upload-modal">
        <div class="upload-modal-content">
            <div class="upload-modal-header">
                <h3>Upload Data File</h3>
                <button class="upload-modal-close" onclick="closeUploadModal()">&times;</button>
            </div>
            <div class="upload-modal-body">
                <div class="upload-area" onclick="document.getElementById('fileInput').click()">
                    <div class="upload-icon">📂</div>
                    <div class="upload-text">Click to upload or drag and drop</div>
                    <div class="upload-subtext">CSV files only. Any structure supported - we'll help you map the fields.</div>
                </div>
                
                <input type="file" id="fileInput" class="file-input" accept=".csv" onchange="handleFileSelect(event)">
                
                <div id="uploadProgress" class="upload-progress">
                    <div class="progress-bar">
                        <div id="progressFill" class="progress-fill"></div>
                    </div>
                    <div style="text-align: center; margin-top: 0.5rem; font-size: 0.85rem; color: #6c757d;">
                        Processing file...
                    </div>
                </div>

                <div id="dataPreview" class="data-preview">
                    <h4 style="margin-bottom: 1rem;">Data Preview</h4>
                    <div style="overflow-x: auto; max-height: 200px; border: 1px solid #e1e5e9; border-radius: 4px;">
                        <table id="previewTable" class="preview-table">
                            <thead id="previewHeader"></thead>
                            <tbody id="previewBody"></tbody>
                        </table>
                    </div>
                </div>

                <div id="fieldMapping" class="field-mapping">
                    <div class="mapping-header">
                        <h4 style="margin-bottom: 0.5rem;">Map Your Data Fields</h4>
                        <p style="color: #6c757d; font-size: 0.85rem;">
                            Map your CSV columns to dashboard fields. Only revenue field is required.
                        </p>
                    </div>
                    
                    <div class="mapping-row">
                        <div class="mapping-info">
                            <div class="mapping-label">Revenue Amount <span class="mapping-required">*</span></div>
                            <div class="mapping-description">The monetary value or amount for each transaction</div>
                        </div>
                        <select id="revenueMapping" class="mapping-select" required>
                            <option value="">-- Select Column --</option>
                        </select>
                    </div>

                    <div class="mapping-row">
                        <div class="mapping-info">
                            <div class="mapping-label">Date <span class="mapping-optional">Optional</span></div>
                            <div class="mapping-description">Transaction or record date</div>
                        </div>
                        <select id="dateMapping" class="mapping-select">
                            <option value="">-- Select Column --</option>
                        </select>
                    </div>

                    <div class="mapping-row">
                        <div class="mapping-info">
                            <div class="mapping-label">ID/Reference <span class="mapping-optional">Optional</span></div>
                            <div class="mapping-description">Unique identifier for each record</div>
                        </div>
                        <select id="idMapping" class="mapping-select">
                            <option value="">-- Select Column --</option>
                        </select>
                    </div>

                    <div class="mapping-row">
                        <div class="mapping-info">
                            <div class="mapping-label">Product/Category <span class="mapping-optional">Optional</span></div>
                            <div class="mapping-description">Product name, service type, or category</div>
                        </div>
                        <select id="productMapping" class="mapping-select">
                            <option value="">-- Select Column --</option>
                        </select>
                    </div>

                    <div class="mapping-row">
                        <div class="mapping-info">
                            <div class="mapping-label">Customer/Client <span class="mapping-optional">Optional</span></div>
                            <div class="mapping-description">Customer name or client identifier</div>
                        </div>
                        <select id="customerMapping" class="mapping-select">
                            <option value="">-- Select Column --</option>
                        </select>
                    </div>

                    <div class="mapping-row">
                        <div class="mapping-info">
                            <div class="mapping-label">Region/Location <span class="mapping-optional">Optional</span></div>
                            <div class="mapping-description">Geographic region, country, or location</div>
                        </div>
                        <select id="regionMapping" class="mapping-select">
                            <option value="">-- Select Column --</option>
                        </select>
                    </div>

                    <div class="mapping-row">
                        <div class="mapping-info">
                            <div class="mapping-label">Status <span class="mapping-optional">Optional</span></div>
                            <div class="mapping-description">Transaction status (completed, pending, etc.)</div>
                        </div>
                        <select id="statusMapping" class="mapping-select">
                            <option value="">-- Select Column --</option>
                        </select>
                    </div>
                </div>

                <div id="uploadActions" class="upload-actions">
                    <button class="action-btn" onclick="closeUploadModal()">Cancel</button>
                    <button class="action-btn primary" onclick="processUploadedData()">Import Data</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let revenueData = {
            transactions: [],
            columns: []
        };
        let revenueChart, breakdownChart;
        let uploadedData = null;

        // Initialize dashboard with sample data
        function initDashboard() {
            // Wait for libraries to load
            if (typeof Chart === 'undefined' || typeof Papa === 'undefined') {
                console.log('Waiting for libraries to load...');
                setTimeout(initDashboard, 500);
                return;
            }

            // Create sample data
            createSampleData();
            updateDashboard();
            setupDragAndDrop();
        }

        // Wait for DOM and libraries to be ready
        function waitForLibraries() {
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', waitForLibraries);
                return;
            }
            
            // Check if required libraries are loaded
            let attempts = 0;
            const maxAttempts = 20;
            
            function checkLibraries() {
                attempts++;
                if (typeof Chart !== 'undefined' && typeof Papa !== 'undefined') {
                    initDashboard();
                } else if (attempts < maxAttempts) {
                    setTimeout(checkLibraries, 500);
                } else {
                    console.error('Failed to load required libraries');
                    showError('Failed to load dashboard components. Please refresh the page.');
                }
            }
            
            checkLibraries();
        }

        function createSampleData() {
            const sampleTransactions = [
                { date: '2025-01-01', id: 'TXN-001', product: 'Software License', customer: 'Tech Corp', revenue: 5000, region: 'North America', status: 'completed' },
                { date: '2025-01-02', id: 'TXN-002', product: 'Consulting', customer: 'Business Inc', revenue: 8500, region: 'Europe', status: 'completed' },
                { date: '2025-01-03', id: 'TXN-003', product: 'Training', customer: 'Education Co', revenue: 3200, region: 'Asia Pacific', status: 'pending' },
                { date: '2025-01-04', id: 'TXN-004', product: 'Support', customer: 'Service Ltd', revenue: 1200, region: 'North America', status: 'completed' },
                { date: '2025-01-05', id: 'TXN-005', product: 'Software License', customer: 'Innovation Hub', revenue: 7500, region: 'Europe', status: 'completed' }
            ];

            revenueData.transactions = sampleTransactions;
            revenueData.columns = Object.keys(sampleTransactions[0]);
        }

        function updateDashboard() {
            updateKPIs();
            updateFilters();
            createCharts();
            populateTransactionTable();
        }

        function updateKPIs() {
            const transactions = revenueData.transactions;
            const completedTransactions = transactions.filter(t => !t.status || t.status.toLowerCase() === 'completed');
            
            const totalRevenue = completedTransactions.reduce((sum, t) => sum + (parseFloat(t.revenue) || 0), 0);
            const avgTransaction = completedTransactions.length > 0 ? totalRevenue / completedTransactions.length : 0;
            const successRate = transactions.length > 0 ? (completedTransactions.length / transactions.length) * 100 : 0;

            document.getElementById('totalRevenue').textContent = formatCurrency(totalRevenue);
            document.getElementById('avgTransaction').textContent = formatCurrency(avgTransaction);
            document.getElementById('totalTransactions').textContent = transactions.length.toLocaleString();
            document.getElementById('successRate').textContent = successRate.toFixed(1) + '%';
        }

        function updateFilters() {
            const transactions = revenueData.transactions;
            
            // Update product filter
            const products = [...new Set(transactions.map(t => t.product).filter(Boolean))];
            const productFilter = document.getElementById('productFilter');
            productFilter.innerHTML = '<option value="all">All Products</option>';
            products.forEach(product => {
                productFilter.innerHTML += `<option value="${product}">${product}</option>`;
            });

            // Update region filter
            const regions = [...new Set(transactions.map(t => t.region).filter(Boolean))];
            const regionFilter = document.getElementById('regionFilter');
            regionFilter.innerHTML = '<option value="all">Global</option>';
            regions.forEach(region => {
                regionFilter.innerHTML += `<option value="${region}">${region}</option>`;
            });
        }

        function createCharts() {
            // Check if Chart.js is loaded
            if (typeof Chart === 'undefined') {
                console.error('Chart.js library not loaded');
                // Show loading message in chart containers
                document.getElementById('revenueChart').parentElement.innerHTML = 
                    '<div class="loading"><div class="spinner"></div>Loading charts...</div>';
                document.getElementById('breakdownChart').parentElement.innerHTML = 
                    '<div class="loading"><div class="spinner"></div>Loading charts...</div>';
                
                // Try to reload charts after a delay
                setTimeout(() => {
                    if (typeof Chart !== 'undefined') {
                        createCharts();
                    }
                }, 2000);
                return;
            }

            // Destroy existing charts
            if (revenueChart && typeof revenueChart.destroy === 'function') {
                revenueChart.destroy();
            }
            if (breakdownChart && typeof breakdownChart.destroy === 'function') {
                breakdownChart.destroy();
            }

            const transactions = revenueData.transactions;
            
            if (transactions.length === 0) {
                // Show no data message
                document.getElementById('revenueChart').parentElement.innerHTML = 
                    '<div style="text-align: center; padding: 2rem; color: #6c757d;">No data available for charts</div>';
                document.getElementById('breakdownChart').parentElement.innerHTML = 
                    '<div style="text-align: center; padding: 2rem; color: #6c757d;">No data available for charts</div>';
                return;
            }

            try {
                // Revenue trend by date
                const revenueByDate = {};
                transactions.forEach(t => {
                    const date = t.date || 'Unknown';
                    revenueByDate[date] = (revenueByDate[date] || 0) + (parseFloat(t.revenue) || 0);
                });

                const ctx1 = document.getElementById('revenueChart');
                if (ctx1) {
                    revenueChart = new Chart(ctx1, {
                        type: 'line',
                        data: {
                            labels: Object.keys(revenueByDate),
                            datasets: [{
                                label: 'Revenue',
                                data: Object.values(revenueByDate),
                                borderColor: '#0070f3',
                                backgroundColor: 'rgba(0, 112, 243, 0.1)',
                                tension: 0.4,
                                fill: true
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: {
                                    display: false
                                }
                            },
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    ticks: {
                                        callback: function(value) {
                                            return formatCurrency(value);
                                        }
                                    }
                                }
                            }
                        }
                    });
                }

                // Revenue breakdown by product/category
                const revenueByProduct = {};
                transactions.forEach(t => {
                    const product = t.product || 'Other';
                    revenueByProduct[product] = (revenueByProduct[product] || 0) + (parseFloat(t.revenue) || 0);
                });

                const ctx2 = document.getElementById('breakdownChart');
                if (ctx2) {
                    breakdownChart = new Chart(ctx2, {
                        type: 'doughnut',
                        data: {
                            labels: Object.keys(revenueByProduct),
                            datasets: [{
                                data: Object.values(revenueByProduct),
                                backgroundColor: ['#0070f3', '#00d4ff', '#28a745', '#ffc107', '#dc3545', '#6f42c1', '#fd7e14'],
                                borderWidth: 2,
                                borderColor: '#ffffff'
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: {
                                    position: 'bottom',
                                    labels: { 
                                        usePointStyle: true, 
                                        padding: 15,
                                        font: { size: 11 }
                                    }
                                }
                            }
                        }
                    });
                }
            } catch (error) {
                console.error('Error creating charts:', error);
                showError('Error creating charts. Please refresh the page.');
            }
        }

        function populateTransactionTable() {
            const headerRow = document.getElementById('tableHeaders');
            const tbody = document.getElementById('transactionTableBody');
            
            headerRow.innerHTML = '';
            tbody.innerHTML = '';

            if (revenueData.transactions.length === 0) {
                tbody.innerHTML = '<tr><td colspan="100%" style="text-align: center; padding: 2rem; color: #6c757d;">No data available. Upload a CSV file to get started.</td></tr>';
                return;
            }

            // Create headers
            revenueData.columns.forEach(column => {
                const th = document.createElement('th');
                th.textContent = formatColumnName(column);
                headerRow.appendChild(th);
            });

            // Populate rows
            revenueData.transactions.forEach(transaction => {
                const row = tbody.insertRow();
                revenueData.columns.forEach(column => {
                    const cell = row.insertCell();
                    let value = transaction[column];
                    
                    // Format values based on column type
                    if (column === 'revenue' || (typeof value === 'number' && column.toLowerCase().includes('amount'))) {
                        value = formatCurrency(value);
                    } else if (column === 'date' && value) {
                        value = new Date(value).toLocaleDateString();
                    } else if (column === 'status' && value) {
                        cell.innerHTML = `<span class="status-indicator status-${value.toLowerCase()}"></span>${value}`;
                        return;
                    }
                    
                    cell.textContent = value || '';
                });
                row.style.cursor = 'pointer';
            });
        }

        function formatColumnName(column) {
            return column.split(/[_\s]+/).map(word => 
                word.charAt(0).toUpperCase() + word.slice(1).toLowerCase()
            ).join(' ');
        }

        function formatCurrency(amount) {
            return new Intl.NumberFormat('en-US', {
                style: 'currency',
                currency: 'USD',
                minimumFractionDigits: 0,
                maximumFractionDigits: 0
            }).format(amount || 0);
        }

        // Upload functionality
        function openUploadModal() {
            document.getElementById('uploadModal').style.display = 'block';
            resetUploadModal();
        }

        function closeUploadModal() {
            document.getElementById('uploadModal').style.display = 'none';
            resetUploadModal();
        }

        function resetUploadModal() {
            document.getElementById('fileInput').value = '';
            document.getElementById('uploadProgress').style.display = 'none';
            document.getElementById('dataPreview').style.display = 'none';
            document.getElementById('fieldMapping').style.display = 'none';
            document.getElementById('uploadActions').style.display = 'none';
            document.getElementById('progressFill').style.width = '0%';
            uploadedData = null;
            hideMessages();
        }

        function setupDragAndDrop() {
            const uploadArea = document.querySelector('.upload-area');
            
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                uploadArea.addEventListener(eventName, preventDefaults, false);
            });

            function preventDefaults(e) {
                e.preventDefault();
                e.stopPropagation();
            }

            ['dragenter', 'dragover'].forEach(eventName => {
                uploadArea.addEventListener(eventName, () => uploadArea.classList.add('dragover'), false);
            });

            ['dragleave', 'drop'].forEach(eventName => {
                uploadArea.addEventListener(eventName, () => uploadArea.classList.remove('dragover'), false);
            });

            uploadArea.addEventListener('drop', handleDrop, false);
        }

        function handleDrop(e) {
            const dt = e.dataTransfer;
            const files = dt.files;
            
            if (files.length > 0) {
                handleFileSelect({target: {files: files}});
            }
        }

        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (!file) return;

            if (!file.name.toLowerCase().endsWith('.csv')) {
                showError('Please select a CSV file.');
                return;
            }

            // Check if Papa Parse is available
            if (typeof Papa === 'undefined') {
                showError('CSV parser not loaded. Please refresh the page and try again.');
                return;
            }

            // Show progress
            document.getElementById('uploadProgress').style.display = 'block';
            animateProgress();

            // Parse CSV
            try {
                Papa.parse(file, {
                    header: true,
                    skipEmptyLines: true,
                    dynamicTyping: true,
                    complete: function(results) {
                        try {
                            if (results.errors.length > 0) {
                                console.warn('CSV parsing warnings:', results.errors);
                            }
                            
                            if (!results.data || results.data.length === 0) {
                                showError('No data found in the CSV file.');
                                document.getElementById('uploadProgress').style.display = 'none';
                                return;
                            }

                            uploadedData = results;
                            showDataPreview(results);
                            setupFieldMapping(results.meta.fields);
                            document.getElementById('uploadProgress').style.display = 'none';
                            document.getElementById('dataPreview').style.display = 'block';
                            document.getElementById('fieldMapping').style.display = 'block';
                            document.getElementById('uploadActions').style.display = 'block';
                        } catch (error) {
                            console.error('Error processing CSV results:', error);
                            showError('Error processing the CSV file: ' + error.message);
                            document.getElementById('uploadProgress').style.display = 'none';
                        }
                    },
                    error: function(error) {
                        console.error('Papa Parse error:', error);
                        showError('Error parsing CSV: ' + error.message);
                        document.getElementById('uploadProgress').style.display = 'none';
                    }
                });
            } catch (error) {
                console.error('Error initiating CSV parse:', error);
                showError('Error reading the CSV file: ' + error.message);
                document.getElementById('uploadProgress').style.display = 'none';
            }
        }

        function animateProgress() {
            const progressFill = document.getElementById('progressFill');
            let width = 0;
            const interval = setInterval(() => {
                width += 10;
                progressFill.style.width = width + '%';
                if (width >= 100) {
                    clearInterval(interval);
                }
            }, 100);
        }

        function showDataPreview(results) {
            const header = document.getElementById('previewHeader');
            const body = document.getElementById('previewBody');
            
            header.innerHTML = '';
            body.innerHTML = '';

            // Create header
            const headerRow = header.insertRow();
            results.meta.fields.forEach(field => {
                const th = document.createElement('th');
                th.textContent = field;
                headerRow.appendChild(th);
            });

            // Show first 5 rows
            const previewData = results.data.slice(0, 5);
            previewData.forEach(row => {
                const tableRow = body.insertRow();
                results.meta.fields.forEach(field => {
                    const cell = tableRow.insertCell();
                    cell.textContent = row[field] || '';
                });
            });
        }

        function setupFieldMapping(fields) {
            const mappingSelects = [
                'revenueMapping', 'dateMapping', 'idMapping', 
                'productMapping', 'customerMapping', 'regionMapping', 'statusMapping'
            ];

            // Populate all mapping selects with available fields
            mappingSelects.forEach(mappingId => {
                const select = document.getElementById(mappingId);
                select.innerHTML = '<option value="">-- Select Column --</option>';
                
                fields.forEach(field => {
                    const option = document.createElement('option');
                    option.value = field;
                    option.textContent = field;
                    select.appendChild(option);
                });
            });

            // Auto-map fields based on intelligent matching
            autoMapFields(fields);
        }

        function autoMapFields(fields) {
            const mappings = {
                revenue: {
                    element: 'revenueMapping',
                    keywords: ['revenue', 'amount', 'value', 'price', 'total', 'sales', 'income', 'cost', 'payment', 'money', 'fee', 'charge']
                },
                date: {
                    element: 'dateMapping',
                    keywords: ['date', 'time', 'created', 'timestamp', 'when', 'day', 'month', 'year']
                },
                id: {
                    element: 'idMapping',
                    keywords: ['id', 'identifier', 'reference', 'ref', 'number', 'num', 'code', 'key', 'transaction']
                },
                product: {
                    element: 'productMapping',
                    keywords: ['product', 'item', 'service', 'category', 'type', 'name', 'description', 'title']
                },
                customer: {
                    element: 'customerMapping',
                    keywords: ['customer', 'client', 'user', 'buyer', 'company', 'organization', 'account']
                },
                region: {
                    element: 'regionMapping',
                    keywords: ['region', 'location', 'country', 'state', 'city', 'area', 'territory', 'zone']
                },
                status: {
                    element: 'statusMapping',
                    keywords: ['status', 'state', 'condition', 'stage', 'progress', 'result']
                }
            };

            // Score each field against each mapping
            fields.forEach(field => {
                const fieldLower = field.toLowerCase();
                let bestMatch = null;
                let bestScore = 0;

                Object.entries(mappings).forEach(([mappingType, config]) => {
                    let score = 0;
                    
                    // Exact keyword match gets highest score
                    config.keywords.forEach(keyword => {
                        if (fieldLower === keyword) {
                            score += 100;
                        } else if (fieldLower.includes(keyword)) {
                            score += 50;
                        } else if (keyword.includes(fieldLower) && fieldLower.length > 2) {
                            score += 25;
                        }
                    });

                    // Boost score for numeric fields when looking for revenue
                    if (mappingType === 'revenue' && uploadedData && uploadedData.data) {
                        const sampleValues = uploadedData.data.slice(0, 5);
                        const hasNumericValues = sampleValues.some(row => {
                            const value = row[field];
                            return typeof value === 'number' || (typeof value === 'string' && !isNaN(parseFloat(value)));
                        });
                        if (hasNumericValues) score += 30;
                    }

                    if (score > bestScore) {
                        bestScore = score;
                        bestMatch = config.element;
                    }
                });

                // Apply the best match if score is significant
                if (bestMatch && bestScore > 20) {
                    const select = document.getElementById(bestMatch);
                    if (select && !select.value) { // Only auto-map if not already mapped
                        select.value = field;
                    }
                }
            });
        }

        function processUploadedData() {
            if (!uploadedData) {
                showError('No data to process');
                return;
            }

            // Get field mappings
            const mappings = {
                revenue: document.getElementById('revenueMapping').value,
                date: document.getElementById('dateMapping').value,
                id: document.getElementById('idMapping').value,
                product: document.getElementById('productMapping').value,
                customer: document.getElementById('customerMapping').value,
                region: document.getElementById('regionMapping').value,
                status: document.getElementById('statusMapping').value
            };

            // Validate required mappings
            if (!mappings.revenue) {
                showError('Please map the Revenue field - this is required.');
                return;
            }

            // Transform and validate data
            const transformedTransactions = [];
            const errors = [];

            uploadedData.data.forEach((row, index) => {
                try {
                    const transaction = {};
                    
                    // Map all available fields, not just the predefined ones
                    Object.keys(row).forEach(originalColumn => {
                        const mappedField = Object.keys(mappings).find(key => mappings[key] === originalColumn);
                        const fieldName = mappedField || originalColumn;
                        transaction[fieldName] = row[originalColumn];
                    });

                    // Ensure required revenue field and validate it's numeric
                    const revenueValue = parseFloat(transaction.revenue);
                    if (isNaN(revenueValue)) {
                        errors.push(`Row ${index + 1}: Revenue value "${transaction.revenue}" is not a valid number`);
                        return;
                    }
                    transaction.revenue = revenueValue;

                    // Generate ID if not provided
                    if (!transaction.id) {
                        transaction.id = `ROW-${String(index + 1).padStart(4, '0')}`;
                    }

                    // Set default date if not provided
                    if (!transaction.date) {
                        transaction.date = new Date().toISOString().split('T')[0];
                    }

                    // Set default status if not provided
                    if (!transaction.status) {
                        transaction.status = 'completed';
                    }

                    transformedTransactions.push(transaction);
                } catch (error) {
                    errors.push(`Row ${index + 1}: ${error.message}`);
                }
            });

            // Show errors if any
            if (errors.length > 0) {
                showError(`Found ${errors.length} error(s):\n${errors.slice(0, 5).join('\n')}`);
                if (errors.length > 5) {
                    console.log('All errors:', errors);
                }
            }

            if (transformedTransactions.length === 0) {
                showError('No valid transactions found in the uploaded data');
                return;
            }

            // Update global data
            revenueData.transactions = transformedTransactions;
            revenueData.columns = Object.keys(transformedTransactions[0]);

            // Refresh dashboard
            updateDashboard();

            // Show success message
            showSuccess(`Successfully imported ${transformedTransactions.length} transactions!`);
            
            setTimeout(() => {
                closeUploadModal();
            }, 2000);
        }

        function showSuccess(message) {
            hideMessages();
            const successDiv = document.getElementById('successMessage');
            successDiv.innerHTML = `<strong>Success!</strong> ${message}`;
            successDiv.style.display = 'block';
            
            setTimeout(() => {
                successDiv.style.display = 'none';
            }, 5000);
        }

        function showError(message) {
            hideMessages();
            const errorDiv = document.getElementById('errorMessage');
            const errorText = document.getElementById('errorText');
            errorText.textContent = message;
            errorDiv.style.display = 'block';
            
            setTimeout(() => {
                errorDiv.style.display = 'none';
            }, 8000);
        }

        function hideMessages() {
            document.getElementById('successMessage').style.display = 'none';
            document.getElementById('errorMessage').style.display = 'none';
        }

        // Export functions
        function exportChart(chartType) {
            showSuccess(`Exporting ${chartType} chart. In production, this would generate a downloadable file.`);
        }

        function exportTable() {
            if (revenueData.transactions.length === 0) {
                showError('No data to export');
                return;
            }

            const headers = revenueData.columns;
            const csv = [
                headers,
                ...revenueData.transactions.map(t => headers.map(col => t[col] || ''))
            ].map(row => row.join(',')).join('\n');

            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'dashboard_data.csv';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
        }

        function refreshData() {
            showSuccess('Data refreshed successfully!');
            updateDashboard();
        }

        // Close modals when clicking outside
        window.addEventListener('click', function(e) {
            const uploadModal = document.getElementById('uploadModal');
            if (e.target === uploadModal) {
                closeUploadModal();
            }
        });

        // Initialize dashboard on page load
        waitForLibraries();
    </script>
</body>
</html>
